\hypertarget{_restore_able_service_8cs_source}{}\doxysection{Restore\+Able\+Service.\+cs}
\label{_restore_able_service_8cs_source}\index{Runtime/Services/Persistence/RestoreAbleService.cs@{Runtime/Services/Persistence/RestoreAbleService.cs}}
\mbox{\hyperlink{_restore_able_service_8cs}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00001}00001 \textcolor{keyword}{using }\mbox{\hyperlink{_boolean_notifier_8cs_a81a223a02c34d82b47199f08308847f2}{System}};}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00002}00002 \textcolor{keyword}{using }System.Collections.Generic;}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00003}00003 \textcolor{keyword}{using }System.Linq;}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00004}00004 \textcolor{keyword}{using }System.Threading.Tasks;}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00005}00005 \textcolor{keyword}{using }\mbox{\hyperlink{namespace_uni_rx_extension}{UniRxExtension}};}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00006}00006 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00007}00007 \textcolor{keyword}{internal} \textcolor{keyword}{static} \textcolor{keyword}{class }RestoreAbleService}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00008}00008 \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00009}00009     \textcolor{keyword}{internal} \textcolor{keyword}{static} List<string> NamesToList<T>(IEnumerable<T> aiObjects) where T : \mbox{\hyperlink{class_ai_object_model}{AiObjectModel}}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00010}00010     \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00011}00011         \textcolor{keywordflow}{return} aiObjects.Where(a => a != \textcolor{keyword}{null}).Select(a => a.Name).ToList();}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00012}00012     \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00013}00013 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00014}00014     \textcolor{keyword}{internal} \textcolor{keyword}{static} List<string> NamesToList(List<Parameter> aiObjects)}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00015}00015     \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00016}00016         \textcolor{keywordflow}{return} aiObjects.Where(a => a != \textcolor{keyword}{null}).Select(a => a.Name).ToList();}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00017}00017     \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00018}00018 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00019}00019     \textcolor{keyword}{internal} \textcolor{keyword}{static} List<T> OrderByNames<T>(List<string> desiredOrder, List<T> aiObjects) where T : \mbox{\hyperlink{class_ai_object_model}{AiObjectModel}}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00020}00020     \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00021}00021         \textcolor{keywordflow}{return} aiObjects;}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00022}00022     \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00023}00023 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00024}00024     \textcolor{keyword}{internal} \textcolor{keyword}{static} async Task<List<T>> GetAiObjectsSortedByIndex<T>(\textcolor{keywordtype}{string} path, \textcolor{keywordtype}{bool} restoreDebug) where T : \mbox{\hyperlink{class_ai_object_model}{AiObjectModel}}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00025}00025     \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00026}00026         var result = \textcolor{keyword}{new} List<T>();}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00027}00027         var states = await PersistenceAPI.Instance.LoadObjectsOfTypeAsync<\mbox{\hyperlink{class_restore_state}{RestoreState}}>(path, typeof(T));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00028}00028         states = states.OrderBy(s => s.LoadedObject?.Index).ToList();}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00029}00029         }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00030}00030         \textcolor{keywordflow}{foreach} (var s \textcolor{keywordflow}{in} states)}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00031}00031         \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00032}00032             \textcolor{keywordflow}{if} (s.LoadedObject == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00033}00033             \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00034}00034                 DebugService.Log(\textcolor{stringliteral}{"{}Creating error file typeof(T): "{}} + typeof(T) + \textcolor{stringliteral}{"{} s.ModelType: "{}} + s.ModelType + \textcolor{stringliteral}{"{} TType: "{}} + s.type, nameof(RestoreAbleService));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00035}00035                 var error = (T)ErrorObjectService.GetErrorObject(s.ModelType);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00036}00036                 error.Name = \textcolor{stringliteral}{"{}Error"{}};}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00037}00037                 error.Description = \textcolor{stringliteral}{"{}Exception: "{}} + s.Exception.ToString();}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00038}00038                 result.Add(error);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00039}00039             \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00040}00040             \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00041}00041             \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00042}00042                 var model = await \mbox{\hyperlink{class_restore_able}{RestoreAble}}.\mbox{\hyperlink{class_restore_able_a46e3d455780dc6aea6bf7b8d92b2c47d}{Restore}}<T>(s.LoadedObject, restoreDebug);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00043}00043                 result.Add(model);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00044}00044             \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00045}00045         \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00046}00046 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00047}00047         \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00048}00048     \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00049}00049 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00050}00050     \textcolor{keyword}{internal} \textcolor{keyword}{static} async Task<List<Parameter>> GetParameters(\textcolor{keywordtype}{string} path, \textcolor{keywordtype}{bool} restoreDebug)}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00051}00051     \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00052}00052         var result = \textcolor{keyword}{new} List<Parameter>();}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00053}00053         var parameterStates = await PersistenceAPI.Instance.LoadObjectsOfTypeAsync<\mbox{\hyperlink{class_restore_state}{RestoreState}}>(path, typeof(\mbox{\hyperlink{class_parameter}{Parameter}}));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00054}00054         parameterStates = parameterStates.OrderBy(p => p.LoadedObject?.Index).ToList();}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00055}00055         }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00056}00056         \textcolor{keywordflow}{foreach} (var p \textcolor{keywordflow}{in} parameterStates)}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00057}00057         \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00058}00058             \textcolor{keywordflow}{if} (p.LoadedObject == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00059}00059             \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00060}00060                 var parameter = \textcolor{keyword}{new} \mbox{\hyperlink{class_parameter}{Parameter}}(\textcolor{stringliteral}{"{}Error"{}}, p.Exception.ToString());}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00061}00061                 result.Add(parameter);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00062}00062             \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00063}00063             \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00064}00064             \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00065}00065                 var parameter = await \mbox{\hyperlink{class_restore_able}{RestoreAble}}.\mbox{\hyperlink{class_restore_able_a46e3d455780dc6aea6bf7b8d92b2c47d}{Restore}}<\mbox{\hyperlink{class_parameter}{Parameter}}>(p.LoadedObject, restoreDebug);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00066}00066                 result.Add(parameter);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00067}00067             \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00068}00068         \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00069}00069         \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00070}00070     \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00071}00071     }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00072}00072     \textcolor{keyword}{internal} \textcolor{keyword}{static} async Task<List<UtilityContainerSelector>> GetUcs(\textcolor{keywordtype}{string} path, \textcolor{keywordtype}{bool} restoreDebug)}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00073}00073     \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00074}00074         var result = \textcolor{keyword}{new} List<UtilityContainerSelector>();}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00075}00075         var filter = FileExtensionService.GetFileExtensionFromType(typeof(\mbox{\hyperlink{class_utility_container_selector}{UtilityContainerSelector}}));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00076}00076         DebugService.Log(\textcolor{stringliteral}{"{}GetUcs path: "{}} + path + \textcolor{stringliteral}{"{} filter: "{}} + filter, nameof(RestoreAbleService));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00077}00077 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00078}00078         var states = await PersistenceAPI.Instance.LoadObjectsAsync<\mbox{\hyperlink{class_restore_state}{RestoreState}}>(path, filter);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00079}00079         DebugService.Log(\textcolor{stringliteral}{"{}GetUcs number of states: "{}} + states.Count, nameof(RestoreAbleService));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00080}00080 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00081}00081         states = states.OrderBy(s => s.LoadedObject?.Index).ToList();}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00082}00082         \textcolor{keywordflow}{foreach} (var bs \textcolor{keywordflow}{in} states)}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00083}00083         \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00084}00084             \textcolor{keywordflow}{if} (bs.LoadedObject == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00085}00085             \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00086}00086                 DebugService.Log(\textcolor{stringliteral}{"{}GetUcs failed fo load: "{}} + bs.Path, nameof(RestoreAbleService));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00087}00087                 var error = (\mbox{\hyperlink{class_utility_container_selector}{UtilityContainerSelector}})AiObjectFactory.CreateInstance(bs.ModelType);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00088}00088                 var errorParam = \textcolor{keyword}{new} \mbox{\hyperlink{class_parameter}{Parameter}}(\textcolor{stringliteral}{"{}Error"{}}, bs.Exception.ToString());}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00089}00089                 error.AddParameter(errorParam);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00090}00090                 result.Add(error);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00091}00091             \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00092}00092             \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00093}00093             \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00094}00094                 var ucs = await \mbox{\hyperlink{class_restore_able}{RestoreAble}}.\mbox{\hyperlink{class_restore_able_a46e3d455780dc6aea6bf7b8d92b2c47d}{Restore}}<\mbox{\hyperlink{class_utility_container_selector}{UtilityContainerSelector}}>(bs.LoadedObject, restoreDebug);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00095}00095                 DebugService.Log(\textcolor{stringliteral}{"{}GetUcs loaded: "{}} + ucs.FileName, nameof(RestoreAbleService));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00096}00096 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00097}00097                 result.Add(ucs);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00098}00098             \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00099}00099         \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00100}00100         \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00101}00101     \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00102}00102     }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00103}00103     \textcolor{keyword}{internal} \textcolor{keyword}{static} async Task LoadObjectsAndSortToCollection<T>(\textcolor{keywordtype}{string} path, List<string> namesOrdered, }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00104}00104         \mbox{\hyperlink{class_uni_rx_extension_1_1_reactive_list}{ReactiveList<AiObjectModel>}} collection, \textcolor{keywordtype}{bool} restoreDebug) where T: \mbox{\hyperlink{class_ai_object_model}{AiObjectModel}}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00105}00105     \{   }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00106}00106         DebugService.Log(\textcolor{stringliteral}{"{}Loading objects at: "{}} + path, nameof(RestoreAbleService));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00107}00107 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00108}00108         var aiObjects = await GetAiObjectsSortedByIndex<T>(path, restoreDebug);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00109}00109         DebugService.Log(\textcolor{stringliteral}{"{}Loading objects at: "{}} + path + \textcolor{stringliteral}{"{} completed "{}} + aiObjects.Count + \textcolor{stringliteral}{"{} objects loaded"{}}, nameof(RestoreAbleService));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00110}00110         \textcolor{keywordflow}{if} (aiObjects.Count > 0)}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00111}00111         \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00112}00112             var sorted = OrderByNames(namesOrdered, aiObjects);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00113}00113             collection.Add(sorted);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00114}00114         \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00115}00115     \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00116}00116 }
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00117}00117     \textcolor{keyword}{internal} \textcolor{keyword}{static} async Task SaveRestoreAblesToFile<T>(IEnumerable<T> collection, \textcolor{keywordtype}{string} path, \mbox{\hyperlink{interface_i_persister}{IPersister}} persister) where T: \mbox{\hyperlink{class_restore_able}{RestoreAble}}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00118}00118     \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00119}00119         var restoreAbles = collection.ToList();}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00120}00120         \textcolor{keywordflow}{if} (restoreAbles.Count == 0)}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00121}00121         \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00122}00122             \textcolor{comment}{// Cleaning up to delete previously created files}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00123}00123             await PersistenceAPI.CleanUpAsync(path, DateTime.Now);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00124}00124         \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00125}00125         \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00126}00126         \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00127}00127             \textcolor{keywordflow}{foreach} (var element \textcolor{keywordflow}{in} restoreAbles)}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00128}00128             \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00129}00129                 \textcolor{keywordflow}{if} (\textcolor{keywordtype}{string}.IsNullOrEmpty(element.FileName) || \textcolor{keywordtype}{string}.IsNullOrWhiteSpace(element.FileName))}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00130}00130                 \{}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00131}00131                     \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentException(\textcolor{stringliteral}{"{}A valid name must be set for element: "{}} + element);}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00132}00132                 \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00133}00133                 await element.SaveToFile(path,persister,restoreAbles.IndexOf(element));}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00134}00134             \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00135}00135         \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00136}00136     \}}
\DoxyCodeLine{\Hypertarget{_restore_able_service_8cs_source_l00137}00137 \}}

\end{DoxyCode}
