\hypertarget{_task_observable_extensions_8cs_source}{}\doxysection{Task\+Observable\+Extensions.\+cs}
\label{_task_observable_extensions_8cs_source}\index{Editor/UniRx/Scripts/Tasks/TaskObservableExtensions.cs@{Editor/UniRx/Scripts/Tasks/TaskObservableExtensions.cs}}
\mbox{\hyperlink{_task_observable_extensions_8cs}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00001}00001 \textcolor{comment}{// this code is borrowed from RxOfficial(rx.codeplex.com) and modified}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00002}00002 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00003}00003 \textcolor{preprocessor}{\#if (NET\_4\_6 || NET\_STANDARD\_2\_0)}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00004}00004 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00005}00005 \textcolor{keyword}{using }\mbox{\hyperlink{_boolean_notifier_8cs_a81a223a02c34d82b47199f08308847f2}{System}};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00006}00006 \textcolor{keyword}{using }System.Threading.Tasks;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00007}00007 \textcolor{keyword}{using }System.Threading;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00008}00008 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00009}00009 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespace_uni_rx}{UniRx}}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00010}00010 \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00014}00014     \textcolor{keyword}{public} \textcolor{keyword}{static} \textcolor{keyword}{class }TaskObservableExtensions}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00015}00015     \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00023}00023         \textcolor{keyword}{public} \textcolor{keyword}{static} IObservable<Unit> ToObservable(\textcolor{keyword}{this} Task task)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00024}00024         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00025}00025             \textcolor{keywordflow}{if} (task == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00026}00026                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentNullException(\textcolor{stringliteral}{"{}task"{}});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00027}00027 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00028}00028             \textcolor{keywordflow}{return} ToObservableImpl(task, \textcolor{keyword}{null});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00029}00029         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00030}00030 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00039}00039         \textcolor{keyword}{public} \textcolor{keyword}{static} IObservable<Unit> ToObservable(\textcolor{keyword}{this} Task task, IScheduler scheduler)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00040}00040         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00041}00041             \textcolor{keywordflow}{if} (task == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00042}00042                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentNullException(\textcolor{stringliteral}{"{}task"{}});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00043}00043             \textcolor{keywordflow}{if} (scheduler == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00044}00044                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentNullException(\textcolor{stringliteral}{"{}scheduler"{}});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00045}00045 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00046}00046             \textcolor{keywordflow}{return} ToObservableImpl(task, scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00047}00047         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00048}00048 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00049}00049         \textcolor{keyword}{private} \textcolor{keyword}{static} IObservable<Unit> ToObservableImpl(Task task, IScheduler scheduler)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00050}00050         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00051}00051             var res = \textcolor{keywordflow}{default}(IObservable<Unit>);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00052}00052 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00053}00053             \textcolor{keywordflow}{if} (task.IsCompleted)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00054}00054             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00055}00055                 scheduler = scheduler ?? Scheduler.Immediate;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00056}00056 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00057}00057                 \textcolor{keywordflow}{switch} (task.Status)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00058}00058                 \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00059}00059                     \textcolor{keywordflow}{case} TaskStatus.RanToCompletion:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00060}00060                         res = Observable.Return<Unit>(Unit.Default, scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00061}00061                         \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00062}00062                     \textcolor{keywordflow}{case} TaskStatus.Faulted:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00063}00063                         res = Observable.Throw<Unit>(task.Exception.InnerException, scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00064}00064                         \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00065}00065                     \textcolor{keywordflow}{case} TaskStatus.Canceled:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00066}00066                         res = Observable.Throw<Unit>(\textcolor{keyword}{new} TaskCanceledException(task), scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00067}00067                         \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00068}00068                 \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00069}00069             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00070}00070             \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00071}00071             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00072}00072                 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00073}00073                 \textcolor{comment}{// Separate method to avoid closure in synchronous completion case.}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00074}00074                 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00075}00075                 res = ToObservableSlow(task, scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00076}00076             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00077}00077 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00078}00078             \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00079}00079         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00080}00080 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00081}00081         \textcolor{keyword}{private} \textcolor{keyword}{static} IObservable<Unit> ToObservableSlow(Task task, IScheduler scheduler)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00082}00082         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00083}00083             var subject = \textcolor{keyword}{new} AsyncSubject<Unit>();}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00084}00084 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00085}00085             var options = GetTaskContinuationOptions(scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00086}00086 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00087}00087             task.ContinueWith(t => ToObservableDone(task, subject), options);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00088}00088 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00089}00089             \textcolor{keywordflow}{return} ToObservableResult(subject, scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00090}00090         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00091}00091 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00092}00092         \textcolor{keyword}{private} \textcolor{keyword}{static} \textcolor{keywordtype}{void} ToObservableDone(Task task, IObserver<Unit> subject)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00093}00093         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00094}00094             \textcolor{keywordflow}{switch} (task.Status)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00095}00095             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00096}00096                 \textcolor{keywordflow}{case} TaskStatus.RanToCompletion:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00097}00097                     subject.OnNext(Unit.Default);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00098}00098                     subject.OnCompleted();}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00099}00099                     \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00100}00100                 \textcolor{keywordflow}{case} TaskStatus.Faulted:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00101}00101                     subject.OnError(task.Exception.InnerException);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00102}00102                     \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00103}00103                 \textcolor{keywordflow}{case} TaskStatus.Canceled:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00104}00104                     subject.OnError(\textcolor{keyword}{new} TaskCanceledException(task));}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00105}00105                     \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00106}00106             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00107}00107         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00108}00108 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00117}00117         \textcolor{keyword}{public} \textcolor{keyword}{static} IObservable<TResult> ToObservable<TResult>(\textcolor{keyword}{this} Task<TResult> task)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00118}00118         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00119}00119             \textcolor{keywordflow}{if} (task == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00120}00120                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentNullException(\textcolor{stringliteral}{"{}task"{}});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00121}00121 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00122}00122             \textcolor{keywordflow}{return} ToObservableImpl(task, \textcolor{keyword}{null});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00123}00123         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00124}00124 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00134}00134         \textcolor{keyword}{public} \textcolor{keyword}{static} IObservable<TResult> ToObservable<TResult>(\textcolor{keyword}{this} Task<TResult> task, IScheduler scheduler)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00135}00135         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00136}00136             \textcolor{keywordflow}{if} (task == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00137}00137                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentNullException(\textcolor{stringliteral}{"{}task"{}});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00138}00138             \textcolor{keywordflow}{if} (scheduler == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00139}00139                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentNullException(\textcolor{stringliteral}{"{}scheduler"{}});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00140}00140 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00141}00141             \textcolor{keywordflow}{return} ToObservableImpl(task, scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00142}00142         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00143}00143 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00144}00144         \textcolor{keyword}{private} \textcolor{keyword}{static} IObservable<TResult> ToObservableImpl<TResult>(Task<TResult> task, IScheduler scheduler)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00145}00145         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00146}00146             var res = \textcolor{keywordflow}{default}(IObservable<TResult>);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00147}00147 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00148}00148             \textcolor{keywordflow}{if} (task.IsCompleted)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00149}00149             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00150}00150                 scheduler = scheduler ?? Scheduler.Immediate;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00151}00151 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00152}00152                 \textcolor{keywordflow}{switch} (task.Status)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00153}00153                 \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00154}00154                     \textcolor{keywordflow}{case} TaskStatus.RanToCompletion:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00155}00155                         res = Observable.Return<TResult>(task.Result, scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00156}00156                         \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00157}00157                     \textcolor{keywordflow}{case} TaskStatus.Faulted:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00158}00158                         res = Observable.Throw<TResult>(task.Exception.InnerException, scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00159}00159                         \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00160}00160                     \textcolor{keywordflow}{case} TaskStatus.Canceled:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00161}00161                         res = Observable.Throw<TResult>(\textcolor{keyword}{new} TaskCanceledException(task), scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00162}00162                         \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00163}00163                 \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00164}00164             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00165}00165             \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00166}00166             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00167}00167                 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00168}00168                 \textcolor{comment}{// Separate method to avoid closure in synchronous completion case.}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00169}00169                 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00170}00170                 res = ToObservableSlow(task, scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00171}00171             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00172}00172 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00173}00173             \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00174}00174         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00175}00175 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00176}00176         \textcolor{keyword}{private} \textcolor{keyword}{static} IObservable<TResult> ToObservableSlow<TResult>(Task<TResult> task, IScheduler scheduler)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00177}00177         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00178}00178             var subject = \textcolor{keyword}{new} AsyncSubject<TResult>();}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00179}00179 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00180}00180             var options = GetTaskContinuationOptions(scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00181}00181 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00182}00182             task.ContinueWith(t => ToObservableDone(task, subject), options);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00183}00183 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00184}00184             \textcolor{keywordflow}{return} ToObservableResult(subject, scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00185}00185         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00186}00186 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00187}00187         \textcolor{keyword}{private} \textcolor{keyword}{static} \textcolor{keywordtype}{void} ToObservableDone<TResult>(Task<TResult> task, IObserver<TResult> subject)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00188}00188         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00189}00189             \textcolor{keywordflow}{switch} (task.Status)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00190}00190             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00191}00191                 \textcolor{keywordflow}{case} TaskStatus.RanToCompletion:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00192}00192                     subject.OnNext(task.Result);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00193}00193                     subject.OnCompleted();}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00194}00194                     \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00195}00195                 \textcolor{keywordflow}{case} TaskStatus.Faulted:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00196}00196                     subject.OnError(task.Exception.InnerException);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00197}00197                     \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00198}00198                 \textcolor{keywordflow}{case} TaskStatus.Canceled:}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00199}00199                     subject.OnError(\textcolor{keyword}{new} TaskCanceledException(task));}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00200}00200                     \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00201}00201             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00202}00202         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00203}00203 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00204}00204         \textcolor{keyword}{private} \textcolor{keyword}{static} TaskContinuationOptions GetTaskContinuationOptions(IScheduler scheduler)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00205}00205         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00206}00206             var options = TaskContinuationOptions.None;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00207}00207 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00208}00208             \textcolor{keywordflow}{if} (scheduler != \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00209}00209             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00210}00210                 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00211}00211                 \textcolor{comment}{// We explicitly don't special-\/case the immediate scheduler here. If the user asks for a}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00212}00212                 \textcolor{comment}{// synchronous completion, we'll try our best. However, there's no guarantee due to the}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00213}00213                 \textcolor{comment}{// internal stack probing in the TPL, which may cause asynchronous completion on a thread}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00214}00214                 \textcolor{comment}{// pool thread in order to avoid stack overflows. Therefore we can only attempt to be more}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00215}00215                 \textcolor{comment}{// efficient in the case where the user specified a scheduler, hence we know that the}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00216}00216                 \textcolor{comment}{// continuation will trigger a scheduling operation. In case of the immediate scheduler,}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00217}00217                 \textcolor{comment}{// it really becomes "{}immediate scheduling"{} wherever the TPL decided to run the continuation,}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00218}00218                 \textcolor{comment}{// i.e. not necessarily where the task was completed from.}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00219}00219                 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00220}00220                 options |= TaskContinuationOptions.ExecuteSynchronously;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00221}00221             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00222}00222 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00223}00223             \textcolor{keywordflow}{return} options;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00224}00224         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00225}00225 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00226}00226         \textcolor{keyword}{private} \textcolor{keyword}{static} IObservable<TResult> ToObservableResult<TResult>(AsyncSubject<TResult> subject, IScheduler scheduler)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00227}00227         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00228}00228             \textcolor{keywordflow}{if} (scheduler != \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00229}00229             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00230}00230                 \textcolor{keywordflow}{return} subject.ObserveOn(scheduler);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00231}00231             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00232}00232             \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00233}00233             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00234}00234                 \textcolor{keywordflow}{return} subject.AsObservable();}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00235}00235             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00236}00236         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00237}00237 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00245}00245         \textcolor{keyword}{public} \textcolor{keyword}{static} Task<TResult> ToTask<TResult>(\textcolor{keyword}{this} IObservable<TResult> observable)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00246}00246         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00247}00247             \textcolor{keywordflow}{if} (observable == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00248}00248                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentNullException(\textcolor{stringliteral}{"{}observable"{}});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00249}00249 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00250}00250             \textcolor{keywordflow}{return} observable.ToTask(\textcolor{keyword}{new} CancellationToken(), \textcolor{keyword}{null});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00251}00251         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00252}00252 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00261}00261         \textcolor{keyword}{public} \textcolor{keyword}{static} Task<TResult> ToTask<TResult>(\textcolor{keyword}{this} IObservable<TResult> observable, \textcolor{keywordtype}{object} state)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00262}00262         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00263}00263             \textcolor{keywordflow}{if} (observable == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00264}00264                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentNullException(\textcolor{stringliteral}{"{}observable"{}});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00265}00265 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00266}00266             \textcolor{keywordflow}{return} observable.ToTask(\textcolor{keyword}{new} CancellationToken(), state);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00267}00267         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00268}00268 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00277}00277         \textcolor{keyword}{public} \textcolor{keyword}{static} Task<TResult> ToTask<TResult>(\textcolor{keyword}{this} IObservable<TResult> observable, CancellationToken cancellationToken)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00278}00278         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00279}00279             \textcolor{keywordflow}{if} (observable == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00280}00280                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentNullException(\textcolor{stringliteral}{"{}observable"{}});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00281}00281 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00282}00282             \textcolor{keywordflow}{return} observable.ToTask(cancellationToken, \textcolor{keyword}{null});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00283}00283         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00284}00284 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00294}00294         \textcolor{keyword}{public} \textcolor{keyword}{static} Task<TResult> ToTask<TResult>(\textcolor{keyword}{this} IObservable<TResult> observable, CancellationToken cancellationToken, \textcolor{keywordtype}{object} state)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00295}00295         \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00296}00296             \textcolor{keywordflow}{if} (observable == \textcolor{keyword}{null})}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00297}00297                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} ArgumentNullException(\textcolor{stringliteral}{"{}observable"{}});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00298}00298 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00299}00299             var hasValue = \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00300}00300             var lastValue = \textcolor{keywordflow}{default}(TResult);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00301}00301 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00302}00302             var tcs = \textcolor{keyword}{new} TaskCompletionSource<TResult>(state);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00303}00303 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00304}00304             var disposable = \textcolor{keyword}{new} SingleAssignmentDisposable();}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00305}00305 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00306}00306             var ctr = \textcolor{keywordflow}{default}(CancellationTokenRegistration);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00307}00307 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00308}00308             \textcolor{keywordflow}{if} (cancellationToken.CanBeCanceled)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00309}00309             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00310}00310                 ctr = cancellationToken.Register(() =>}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00311}00311                 \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00312}00312                     disposable.Dispose();}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00313}00313                     tcs.TrySetCanceled(cancellationToken);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00314}00314                 \});}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00315}00315             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00316}00316 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00317}00317             var taskCompletionObserver = Observer.Create<TResult>(}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00318}00318                 value =>}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00319}00319                 \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00320}00320                     hasValue = \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00321}00321                     lastValue = value;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00322}00322                 \},}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00323}00323                 ex =>}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00324}00324                 \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00325}00325                     tcs.TrySetException(ex);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00326}00326 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00327}00327                     ctr.Dispose(); \textcolor{comment}{// no null-\/check needed (struct)}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00328}00328                     disposable.Dispose();}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00329}00329                 \},}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00330}00330                 () =>}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00331}00331                 \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00332}00332                     \textcolor{keywordflow}{if} (hasValue)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00333}00333                         tcs.TrySetResult(lastValue);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00334}00334                     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00335}00335                         tcs.TrySetException(\textcolor{keyword}{new} InvalidOperationException(\textcolor{stringliteral}{"{}Strings\_Linq.NO\_ELEMENTS"{}}));}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00336}00336 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00337}00337                     ctr.Dispose(); \textcolor{comment}{// no null-\/check needed (struct)}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00338}00338                     disposable.Dispose();}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00339}00339                 \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00340}00340             );}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00341}00341 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00342}00342             \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00343}00343             \textcolor{comment}{// Subtle race condition: if the source completes before we reach the line below, the SingleAssigmentDisposable}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00344}00344             \textcolor{comment}{// will already have been disposed. Upon assignment, the disposable resource being set will be disposed on the}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00345}00345             \textcolor{comment}{// spot, which may throw an exception. (Similar to TFS 487142)}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00346}00346             \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00347}00347             \textcolor{keywordflow}{try}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00348}00348             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00349}00349                 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00350}00350                 \textcolor{comment}{// [OK] Use of unsafe Subscribe: we're catching the exception here to set the TaskCompletionSource.}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00351}00351                 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00352}00352                 \textcolor{comment}{// Notice we could use a safe subscription to route errors through OnError, but we still need the}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00353}00353                 \textcolor{comment}{// exception handling logic here for the reason explained above. We cannot afford to throw here}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00354}00354                 \textcolor{comment}{// and as a result never set the TaskCompletionSource, so we tunnel everything through here.}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00355}00355                 \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00356}00356                 disposable.Disposable = observable.Subscribe\textcolor{comment}{/*Unsafe*/}(taskCompletionObserver);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00357}00357             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00358}00358             \textcolor{keywordflow}{catch} (Exception ex)}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00359}00359             \{}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00360}00360                 tcs.TrySetException(ex);}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00361}00361             \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00362}00362 }
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00363}00363             \textcolor{keywordflow}{return} tcs.Task;}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00364}00364         \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00365}00365     \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00366}00366 \}}
\DoxyCodeLine{\Hypertarget{_task_observable_extensions_8cs_source_l00367}00367 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
